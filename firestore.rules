rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Questions: public read, only admins (custom claim) can write
    match /questions/{docId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Responses: authenticated users can create responses for themselves
    match /responses/{respId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      // allow users to read their own responses, or allow admins
      allow get, list: if request.auth != null && (
        request.auth.uid == resource.data.uid || request.auth.token.admin == true
      );
      // disallow updates/deletes from clients
      allow update, delete: if false;
    }

    // Accounts: each user document is owned by that user; admins may read/delete
    match /accounts/{userId} {
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow get, list: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Profiles: similar to accounts, owned by user
    match /profiles/{userId} {
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow get, list: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
      allow delete: if false;
    }

    // deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
